extends ../layout

block banner
    .parallax#cart-banner
        div.container-fluid.head-banner
            h2 Đăng nhập
            p

block content
    .container.w-50.p-4
        .card.px-4.pb-3
            form.card-body.row
                .col-12.p-0
                    label.w-100(for='email') Email:
                        input#email.form-control(type='email' name='email' required)
                        span#email-err(aria-live="polite").error.px-3
                .col-12.p-0
                    label(for='password').w-100 Mật khẩu:
                        input#password.form-control(type='password' name='password' required)
                        span#password-err(aria-live="polite").error.px-3
                .col-12.w-100.d-flex.flex-column.align-items-center
                    button#btn-sigin.btn.btn-primary.w-50(type="submit") Đăng Nhập
                    a(href='/forgot-pw').font-14 Quên mật khẩu?

            p.text-center.font-16.m-0 Hoặc, đăng nhập với
            form.row.align-items-stretch
                .col-12
                    button.w-100.btn.my-2 Đăng nhập bằng Google
                //.col-12
                //    button.w-100.btn.my-2 Đăng nhập bằng Facebook
            .text-center
                p.font-16 Chưa có tài khoản?
                    a(href="/register").pt-3 Đăng ký

block script
    script.
        $(document).ready(() => {
            $("#btn-sigin").click(
                (e) => {
                    e.preventDefault()
                    var email = $("#email")
                    var password = $("#password")
                    console.log(email.val(), password.val())
                    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                    firebase.auth().signInWithEmailAndPassword(email.val(), password.val())
                        .then(async (userCredential) => {
                            // Signed in
                            // ...
                            const idToken = await userCredential.user.getIdToken(true)
                            const uid = userCredential.user.uid

                            var response = await fetch("/verify_id_token", {
                                method: "POST",
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    idToken: idToken,
                                    uid:uid
                                })
                            })
                            return response
                        }).then(async value => {
                            console.log(value)
                        if(value.status == 200){
                            window.location.href= "/account/profile"
                        } else {
                            const json = await value.json()
                            alert(json.message)
                        }

                    })
                        .catch((error) => {
                            var errorCode = error.code;
                            var errorMessage = error.message;
                            // ..
                            alert(errorMessage)
                        });
                })
        })